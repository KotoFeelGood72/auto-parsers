name: Test and Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linting
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐ¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ JavaScript Ñ„Ð°Ð¹Ð»Ð¾Ð²
        find src -name "*.js" -exec node -c {} \;
        echo "âœ… Ð¡Ð¸Ð½Ñ‚Ð°ÐºÑÐ¸Ñ JavaScript Ñ„Ð°Ð¹Ð»Ð¾Ð² ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚ÐµÐ½"
        
    - name: Test database schema
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ SQL ÑÑ…ÐµÐ¼Ñ‹
        node -e "
          const { getCreateTablesSQL } = require('./src/database/schema');
          const sqls = getCreateTablesSQL();
          console.log('âœ… SQL ÑÑ…ÐµÐ¼Ð° ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð°, Ñ‚Ð°Ð±Ð»Ð¸Ñ†:', sqls.length);
        "
        
    - name: Test parser configuration
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð°Ñ€ÑÐµÑ€Ð¾Ð²
        node -e "
          const fs = require('fs');
          const configs = fs.readdirSync('./src/parsers/configs')
            .filter(f => f.endsWith('.json'))
            .map(f => JSON.parse(fs.readFileSync('./src/parsers/configs/' + f, 'utf8')));
          console.log('âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¿Ð°Ñ€ÑÐµÑ€Ð¾Ð² Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹:', configs.length);
        "
        
    - name: Build Docker image
      run: |
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ Docker Ð¾Ð±Ñ€Ð°Ð·Ð°
        docker build -t auto-parser-test .
        echo "âœ… Docker Ð¾Ð±Ñ€Ð°Ð· ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾"
        
    - name: Test Docker Compose
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚ÑŒ docker-compose Ñ„Ð°Ð¹Ð»Ð¾Ð²
        docker-compose -f docker-compose.yml config
        docker-compose -f docker-compose.prod.yml config
        echo "âœ… Docker Compose Ñ„Ð°Ð¹Ð»Ñ‹ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹"
        
    - name: Security scan
      run: |
        # ÐŸÑ€Ð¾ÑÑ‚Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
        echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸..."
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ Ð·Ð°Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð¶ÐµÐ½Ñ‹ Ð² ÐºÐ¾Ð´Ðµ
        if grep -r "password.*=" src/ --include="*.js" | grep -v "DB_PASSWORD"; then
          echo "âš ï¸ Ð’Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð·Ð°Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸"
        else
          echo "âœ… Ð—Ð°Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð¶ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹"
        fi
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ñ„Ð°Ð¹Ð»Ð°Ð¼
        if [ -f deploy.sh ] && [ -x deploy.sh ]; then
          echo "âœ… Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹"
        else
          echo "âŒ Ð¡ÐºÑ€Ð¸Ð¿Ñ‚ Ð´ÐµÐ¿Ð»Ð¾Ñ Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»Ð½ÑÐµÐ¼Ñ‹Ð¹"
        fi
        
    - name: Check file permissions
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð²Ð°Ð¶Ð½Ñ‹Ð¼ Ñ„Ð°Ð¹Ð»Ð°Ð¼
        ls -la deploy.sh setup_server.sh
        echo "âœ… ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð°Ð¼ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐµÐ½Ñ‹"
        
    - name: Generate test report
      run: |
        echo "# Test Report" > test-report.md
        echo "## Summary" >> test-report.md
        echo "- âœ… Code syntax check passed" >> test-report.md
        echo "- âœ… Database schema validation passed" >> test-report.md
        echo "- âœ… Parser configurations loaded" >> test-report.md
        echo "- âœ… Docker build successful" >> test-report.md
        echo "- âœ… Docker Compose validation passed" >> test-report.md
        echo "- âœ… Security scan completed" >> test-report.md
        echo "" >> test-report.md
        echo "## Files tested:" >> test-report.md
        echo "- src/database/schema.js" >> test-report.md
        echo "- src/parsers/configs/*.json" >> test-report.md
        echo "- Dockerfile" >> test-report.md
        echo "- docker-compose.yml" >> test-report.md
        echo "- docker-compose.prod.yml" >> test-report.md
        echo "- deploy.sh" >> test-report.md
        echo "- setup_server.sh" >> test-report.md
        
    - name: Upload test report
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: test-report.md
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('test-report.md', 'utf8');
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ§ª Test Results\n\n${report}`
          });
